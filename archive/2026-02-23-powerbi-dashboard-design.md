# Power BI 看板设计文档

**项目**：LMT-Kanban 线边仓物料流转看板
**日期**：2026-02-23
**阶段**：Page 1 晨会总览（已设计确认）

---

## 整体结构

共两页，逐步实现：

| 页面 | 名称 | 目标用户 | 功能 |
|------|------|----------|------|
| Page 1 | 晨会总览 | 车间主管 | 状态信息，每日晨会使用 |
| Page 2 | 操作明细 | 仓库人员 | 执行信息，含条码，对接 WMS 操作 |

页面跳转方式：Page 1 表格/卡片右键 Drill-through → Page 2（自动传入筛选条件）。

---

## Page 1 — 晨会总览

### 布局（16:9 标准）

```
┌──────────────────────────────────────────────────────────────┐
│  [KPI-1 退料预警组数]  [KPI-2 高风险组数]  [KPI-3 超发行数]  [KPI-4 最大超发量]  │  20%
├────────────────────────────────┬─────────────────────────────┤
│                                │                             │
│   各产线退料预警组数（横条形图）  │   TOP10 退料清单（表格）     │  55%
│                                │                             │
├────────────────────────────────┴─────────────────────────────┤
│  [超发TOP1]  [超发TOP2]  [超发TOP3]  [超发TOP4]  [超发TOP5]  [⚠️说明]  │  25%
└──────────────────────────────────────────────────────────────┘
```

---

### 顶部 KPI 卡片（4张）

| # | 标题 | DAX 公式 | 颜色 | 说明 |
|---|------|----------|------|------|
| 1 | 退料预警组数 | `COUNTROWS(AlertReport)` | 白底黑字 | 完工工单仍有库存的总组数 |
| 2 | 高风险组数 | `COUNTROWS(FILTER(AlertReport, [偏差(实际-理论)] > 0))` | 红底白字 | 账面多余，需立即处理 |
| 3 | 超发行数 | `COUNTROWS(FILTER(IssueAuditReport, [超发量] > 0.01))` | 橙底白字 | 实际发料 > 计划发料 |
| 4 | 最大超发量 | `MAX(IssueAuditReport[超发量])` | 灰底黑字 | 单条最严重超发量（件） |

---

### 中部左：各产线退料预警组数（横条形图）

- **图表类型**：Clustered Bar Chart（水平条形）
- **Y 轴**：`线边仓`（alert_report 字段，名称已含产线信息）
- **X 轴**：`COUNTROWS` 聚合（预警组数）
- **排序**：X 轴降序
- **颜色**：单色红系，条越长颜色越深（条件格式）
- **交互**：点击某产线 → 右侧表格联动筛选

---

### 中部右：TOP10 退料清单（表格）

- **数据源**：`AlertReport`，按 `偏差(实际-理论)` 降序，取前10行
- **展示列**：

| 列名 | 来源字段 | 格式 |
|------|----------|------|
| 工单号 | `工单号` | 后6位缩略显示 |
| 物料描述 | `物料描述` | 截断30字 |
| 偏差（件） | `偏差(实际-理论)` | 数值红色渐变条件格式 |
| 线边仓 | `线边仓` | 文本 |

- **交互**：行右键 → Drill-through 到 Page 2（传入工单号+物料编号）
- **底部**：`[查看全部退料明细 →]` 按钮，跳转 Page 2 不带筛选

---

### 底部：超发 TOP5 卡片 + 数据说明

- **卡片数量**：5张超发卡 + 1张说明卡，均分底部宽度
- **每张卡片内容**（3行）：
  1. 物料编号（缩写，如 `100022...`）
  2. 超发件数（大字，橙色，如 `+86,400 件`）
  3. 所在产线
- **颜色**：橙色边框，数字加粗
- **说明卡内容**：`⚠️ 当前数据覆盖近期约200张备料单，非全量。全量数据需定时任务采集。`
- **交互**：点击卡片 → Drill-through 到 Page 2 超发明细（传入物料编号）

---

## Page 2 — 操作明细（待设计）

### 功能定位

- 目标用户：仓库人员（只能访问 WMS）
- 核心需求：提供**条码级**明细，可直接拿去 WMS 扫码处理
- 触发方式：从 Page 1 Drill-through 传入，或直接访问后手动筛选

### 需要的数据（build_report.py 待更新）

当前 `alert_report.csv` 在生成时已聚合，丢失了条码维度。需新增一个明细输出文件：

```
alert_report_detail.csv  ← 保留条码级别，每行一个条码
字段：工单号, 物料编号, 物料描述, 条码, 现存量, 接收时间, 线边仓, 偏差(所属组)
```

**Page 2 布局**（待下一阶段详细设计）：
- 筛选栏：工单号 / 产线 / 日期范围
- 主表：条码级明细，含条码字段，可导出 Excel
- 汇总行：该筛选下的总库存量、条码数

---

## Power BI 数据导入步骤

### 1. 数据源文件

| Power BI 表名 | 文件路径 | 编码 |
|---------------|----------|------|
| `AlertReport` | `data/raw/alert_report.csv` | UTF-8 with BOM |
| `IssueAuditReport` | `data/raw/issue_audit_report.csv` | UTF-8 with BOM |

> Page 2 完成后补充：`AlertReportDetail`（`alert_report_detail.csv`）

### 2. 导入方式

```
Power BI Desktop
→ 主页 → 获取数据 → 文本/CSV
→ 选择文件 → 确认分隔符（逗号）和编码（UTF-8）
→ 加载
```

建议使用**文件夹连接**而非单文件，这样每次刷新自动读取最新 `_latest` 文件。

### 3. 字段类型调整

在 Power Query 中确认以下字段类型：

| 表 | 字段 | 类型 |
|----|------|------|
| AlertReport | `偏差(实际-理论)` | 小数 |
| AlertReport | `实际库存(合计)` | 小数 |
| AlertReport | `接收时间` | 日期/时间 |
| IssueAuditReport | `超发量` | 小数 |
| IssueAuditReport | `超发率(%)` | 小数 |

### 4. DAX 度量值

在 Power BI 模型视图中新建度量值表，添加以下公式：

```dax
// ─── AlertReport 度量值 ───────────────────────────
退料预警组数 = COUNTROWS(AlertReport)

高风险组数 =
COUNTROWS(FILTER(AlertReport, AlertReport[偏差(实际-理论)] > 0))

// ─── IssueAuditReport 度量值 ──────────────────────
超发行数 =
COUNTROWS(FILTER(IssueAuditReport, IssueAuditReport[超发量] > 0.01))

最大超发量 =
MAX(IssueAuditReport[超发量])

// ─── 复合度量值 ───────────────────────────────────
高风险占比 =
DIVIDE([高风险组数], [退料预警组数])
```

### 5. Drill-through 配置

1. 进入 Page 2（操作明细页）
2. 可视化窗格 → 展开「钻取」区域
3. 将 `工单号` 和 `物料编号` 字段拖入「添加钻取字段」
4. 回到 Page 1，右键表格行 → 即可看到「钻取 → Page 2」选项

---

## 后续迭代计划

| 优先级 | 内容 | 依赖 |
|--------|------|------|
| P0 | Page 1 晨会总览（本文档） | alert_report.csv + issue_audit_report.csv |
| P1 | Page 2 退料操作明细（含条码） | build_report.py 新增 alert_report_detail.csv |
| P2 | Page 3 超发操作明细 | NWMS 全量数据 |
| P3 | Page 4 库龄分析 | inventory_latest.csv（已有） |
| P4 | Page 5 齐套检查 | 在制工单 + BOM + 库存三表 |
