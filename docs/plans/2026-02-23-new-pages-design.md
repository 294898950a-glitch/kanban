# 新增页面设计方案：指标说明页 + 数据明细页

**日期**：2026-02-23
**背景**：用户（仓库人员/生产主管）需要理解指标计算逻辑，并能按工单/物料编号溯源作业记录。

---

## 一、整体架构

### 导航方式
引入 `react-router-dom`，三条路由：

| 路由 | 页面 |
|------|------|
| `/` | 仪表盘（现有内容迁移至 Dashboard.tsx） |
| `/docs` | 指标说明页 |
| `/detail` | 数据明细页 |

### 导航栏（NavRail）
- 左侧固定，常驻展开（240px 宽）
- MD Navigation Drawer 风格，Tailwind 实现，不引入 MUI
- 三个导航项（图标 + 标签）：仪表盘 / 指标说明 / 数据明细
- 当前页 pill 高亮（蓝色 indicator）
- 底部显示最后同步时间戳

### 文件改动清单

```
src/
  pages/
    Dashboard.tsx        ← 原 App.tsx 主体内容迁移
    MetricsDoc.tsx       ← 新建（静态内容）
    DetailPage.tsx       ← 新建（两 Tab + 筛选表格）
  components/
    NavRail.tsx          ← 新建导航栏组件
  App.tsx                ← 改为路由壳（NavRail + <Outlet />）

src/api/main.py          ← 新增 3 个接口
```

---

## 二、指标说明页（`/docs`）

### 设计原则
- 纯静态内容，无需后端接口
- 两个卡片区块，直接展示，不折叠
- 公式使用等宽字体 + 浅色背景框显示

### 区块一：离场审计 · 退料预警

**数据来源**：IMES 工单 + IMES BOM + SSRS 线边仓库存

| 指标 | 计算方式 |
|------|----------|
| BOM 总需求量 | BOM 表 `sumQty`（计划数量 × 单件用量） |
| 理论余料 | `BOM总需求量 - 完工数量 × BOM单件用量` |
| 偏差（账面超发） | `实际库存 - 理论余料`，> 0 代表线边仓库存超出理论应剩 |
| 高风险 | 偏差 > 0.01 的组合，需立即盘点 |

**触发条件**：工单状态为已完成（Completed），且该工单对应物料仍有线边仓库存。

### 区块二：进场审计 · 超发发料

**数据来源**：NWMS 备料单行明细（`woissueLineDetail` API）

| 指标 | 来源 |
|------|------|
| 计划发料量 | NWMS 备料单行 `demandQuantity`（备料员创建备料单时录入） |
| 实际发料量 | NWMS 扫码明细 `actualQuantity`（实物扫码入线边仓汇总） |
| 超发量 | `实际发料量 - 计划发料量`，> 0 即超发 |
| 超发率 | `超发量 / 计划发料量 × 100%` |

**触发条件**：实际扫码入线边仓数量超出备料单计划数量（超发量 > 0.01）。

### 区块三：数据来源与同步频率

| 系统 | 数据内容 | 同步频率 |
|------|----------|----------|
| IMES | 工单状态、BOM 明细 | 每日 6–22 点整点 |
| SSRS | 线边仓库存（条码级） | 每日 6–22 点整点 |
| NWMS | 备料单发料明细 | 每日凌晨 2 点全量 |

---

## 三、数据明细页（`/detail`）

### 设计原则
- 目标用户：仓库人员（溯源作业）
- 保持简洁，无展开行，无弹窗
- 关键字搜索是核心交互

### 顶部控件（两 Tab 共用）
```
[ 批次选择下拉 ▼ ]   [ 🔍 搜索工单号 / 物料编号 ]
```

### Tab 1：离场审计（退料预警明细）

**快捷筛选 Chip**：`全部` / `仅高风险（偏差 > 0）`

**表格字段**（7列）：

| 工单号 | 物料编号 | 物料描述 | 线边仓 | 实际库存 | 理论余料 | 偏差 |
|--------|----------|----------|--------|----------|----------|------|

偏差列颜色规则：
- > 0：红色（`text-red-400`）
- ≈ 0：灰色
- < 0：蓝色（理论余料比实际多，正常范围）

### Tab 2：进场审计（超发发料明细）

**快捷筛选 Chip**：`全部` / `仅超发` / `少发`

**表格字段**（7列）：

| 备料单号 | 物料编号 | 关联工单 | 产线 | 计划发料量 | 实际发料量 | 超发量 |
|----------|----------|----------|------|------------|------------|--------|

超发量列颜色规则同上。

---

## 四、新增后端接口

### `GET /api/batches`
返回所有历史批次列表，供下拉选择。
```json
["20260223_060001", "20260223_070001", ...]
```

### `GET /api/alerts/list?batch_id=&q=`
返回指定批次的离场审计完整明细，支持 `q` 关键字（工单号或物料编号 LIKE 过滤）。
```json
[
  {
    "shop_order": "WO-001",
    "material_code": "MAT-001",
    "material_desc": "...",
    "warehouse": "...",
    "actual_inventory": 10.0,
    "theory_remain": 8.0,
    "deviation": 2.0
  }
]
```

### `GET /api/issues/list?batch_id=&q=`
返回指定批次的进场审计完整明细，支持 `q` 关键字（物料编号或备料单号 LIKE 过滤）。
```json
[
  {
    "demand_list_number": "DL-001",
    "material_code": "MAT-001",
    "related_wo": "WO-001",
    "production_line": "...",
    "demand_qty": 100.0,
    "actual_qty": 110.0,
    "over_issue_qty": 10.0
  }
]
```

---

## 五、不做的事（YAGNI）

- 不引入 MUI / Ant Design 等组件库
- 不做行展开 / 弹窗
- 不做导出 Excel
- 不做用户权限分级
- 不做跨批次对比分析
