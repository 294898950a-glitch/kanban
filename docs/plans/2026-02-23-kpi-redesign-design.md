# KPI 重构设计方案

**日期**：2026-02-23
**目标**：以操作人员现场信息需求为中心，重构仪表盘 KPI 卡片和数据明细页，去除理论计算噪音，聚焦可直接指导操作的信息。

---

## 一、核心设计原则调整

### 原有问题
「偏差（实际库存 - 理论余料）」作为核心 KPI 存在系统性误导：
- 提前合并送料（下一工单的料提前入线边仓）会导致偏差虚高
- 实际消耗超出 BOM 标准（返工、报废）导致理论余料失准
- BOM 数据维护滞后同样影响计算结果

### 设计原则
> **工单已完工 + 线边仓仍有该工单物料 = 退料预警**
> 不依赖偏差计算，回归业务本质。

---

## 二、KPI 卡片重构（4 → 5 张）

| # | 标题 | 触发条件 | 小字备注 | 颜色 |
|---|------|----------|----------|------|
| 1 | 当期退料预警 | 2026工单已匹配 + 完工 + 仍有库存 | 完工工单线边仓仍有库存，需退料处理 | 红 |
| 2 | 工单范围外库存 | 接收时间≥2026，工单超出监控窗口 | 近期收料但挂载历史工单，需人工核查 | 橙 |
| 3 | 历史遗留库存 | 接收时间<2026 或为空 | 监控上线前存量，不纳入预警计算 | 灰 |
| 4 | 进场超发预警 | NWMS 实际发料量 > 计划发料量 | 实际扫码入线边仓数量超出备料计划 | 黄 |
| 5 | 当期平均库龄 | 卡片1对应物料的平均滞留时效（小时） | 仅统计当期已核实退料预警物料 | 紫 |

**废弃字段（保留DB，不再前台展示）**：
- `high_risk_count`（偏差>0 过滤）——改为卡片1不过滤偏差
- `alert_group_count`（旧总数）——拆分为卡片1+2+3三层

---

## 三、仪表盘新增：库龄分布色带

KPI 卡片下方新增一行「当期物料库龄分布」，6 个色块横向排列：

| 区间 | 颜色 | 业务含义 |
|------|------|----------|
| ≤1天 | 绿 | 刚入场，正常 |
| 1-3天 | 浅绿 | 观察中 |
| 3-7天 | 黄 | 开始关注 |
| 7-14天 | 橙 | 需要跟进 |
| 14-30天 | 深橙 | 滞留风险 |
| >30天 | 红 | 严重滞留，优先处理 |

每个色块显示条目数，点击后跳转至数据明细页并自动筛选对应库龄区间。
实现方式：纯 Tailwind 色块，无需新增 ECharts 实例。

---

## 四、数据明细页·离场审计 Tab 重构

### 移除字段
- `偏差(实际-理论)`——保留在 DB 和 CSV，不在前台展示
- `理论余料`——同上
- 旧「仅高风险（偏差>0）」Chip——移除

### 新增字段
- `库龄`——当前时间 - 接收时间（天数），颜色规则与仪表盘色带一致
- `单位`——从原表格独立展示（原来未单独列出）

### 新列顺序

| 工单号 | 物料编号 | 物料描述 | 线边仓 | 实际库存量 | 单位 | 库龄 | 条码数 |
|--------|----------|----------|--------|------------|------|------|--------|

### Chip 筛选更新

**旧**：`全部 / 仅高风险（偏差>0）`

**新**：`全部 / ≤3天 / 3-7天 / 7-14天 / >14天`

库龄区间合并小区间（≤1天和1-3天合并为≤3天），减少点击次数，聚焦需要操作的物料。

---

## 五、进场审计 Tab（不变）

字段保持现有结构，偏差列含义明确（NWMS实际-计划，有单位），无需调整。

---

## 六、后端变更范围

### `KPIHistory` 新增字段
- `confirmed_alert_count`——卡片1，当期退料预警数
- `unmatched_current_count`——卡片2，工单范围外库存条目数
- `legacy_count`——卡片3，历史遗留库存条目数
- 旧字段保留，趋势图历史数据不断层

### `/api/kpi/summary` 返回值扩展
新增 3 个字段 + 库龄分布数组：
```
aging_distribution: {
  "le1": N, "d1_3": N, "d3_7": N,
  "d7_14": N, "d14_30": N, "gt30": N
}
```

### `/api/alerts/list` 返回值变更
- 新增 `aging_days`（库龄天数）字段
- 新增 `unit` 字段
- 保留 `deviation` 和 `theory_remain`（不展示但可供导出）

---

## 七、不做的事（YAGNI）
- 不删除 DB 中的偏差和理论余料字段
- 不新增库龄告警推送（通知功能超出当前阶段）
- 进场审计 Tab 不改动
- 指标说明页同步更新「退料预警」说明（移除偏差描述，改为说明现场业务逻辑）
